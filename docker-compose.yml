# Docker Compose for RequestRepo - Production Configuration
# Pulls pre-built image from GitHub Container Registry
#
# Usage:
#   docker compose up -d
#
# For development (builds locally), the docker-compose.override.yml
# file is automatically merged when present.

services:
  requestrepo:
    image: ghcr.io/adrgs/requestrepo:latest
    container_name: requestrepo
    restart: unless-stopped
    ports:
      - "80:80"       # HTTP
      - "443:443"     # HTTPS
      - "53:53/tcp"   # DNS TCP
      - "53:53/udp"   # DNS UDP
      - "25:25"       # SMTP
    env_file:
      - .env
    environment:
      # Required
      - JWT_SECRET=${JWT_SECRET}
      - DOMAIN=${DOMAIN:-requestrepo.com}
      - SERVER_IP=${SERVER_IP:-127.0.0.1}
      # Optional - Auth
      - ADMIN_TOKEN=${ADMIN_TOKEN:-}
      # Optional - Ports
      - HTTP_PORT=${HTTP_PORT:-80}
      - HTTPS_PORT=${HTTPS_PORT:-443}
      - DNS_PORT=${DNS_PORT:-53}
      - SMTP_PORT=${SMTP_PORT:-25}
      # Optional - TLS/ACME
      - TLS_ENABLED=${TLS_ENABLED:-false}
      - ACME_EMAIL=${ACME_EMAIL:-}
      - ACME_DIRECTORY=${ACME_DIRECTORY:-https://acme-v02.api.letsencrypt.org/directory}
      - CERT_DIR=/app/certs
      - CERT_RENEWAL_DAYS=${CERT_RENEWAL_DAYS:-30}
      - CERT_CHECK_HOURS=${CERT_CHECK_HOURS:-12}
      # Optional - Memory management
      - CACHE_MAX_MEMORY_PCT=${CACHE_MAX_MEMORY_PCT:-0.7}
      - MAX_SUBDOMAIN_SIZE_MB=${MAX_SUBDOMAIN_SIZE_MB:-10}
      - MAX_REQUEST_BODY_MB=${MAX_REQUEST_BODY_MB:-10}
      # Optional - Security
      - ALLOW_ALL_HEADERS=${ALLOW_ALL_HEADERS:-false}
      # Optional - Error tracking
      - SENTRY_DSN_BACKEND=${SENTRY_DSN_BACKEND:-}
      - SENTRY_DSN_FRONTEND=${SENTRY_DSN_FRONTEND:-}
      # Logging
      - RUST_LOG=${RUST_LOG:-info}
    volumes:
      - certs:/app/certs
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 256M
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://127.0.0.1:80/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    # Security options
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE  # Required for binding to ports < 1024

volumes:
  certs:
    driver: local
