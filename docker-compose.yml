# Docker Compose for RequestRepo Rust backend (single container)
# No Redis dependency - uses in-memory cache with LRU eviction

version: "3.8"

services:
  requestrepo:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: requestrepo
    restart: always
    ports:
      - "80:80"       # HTTP
      - "443:443"     # HTTPS
      - "53:53/tcp"   # DNS TCP
      - "53:53/udp"   # DNS UDP
      - "25:25"       # SMTP
    env_file:
      - .env
    environment:
      # Required
      - JWT_SECRET=${JWT_SECRET}
      - DOMAIN=${DOMAIN:-requestrepo.com}
      - SERVER_IP=${SERVER_IP:-127.0.0.1}
      # Optional - Auth
      - ADMIN_TOKEN=${ADMIN_TOKEN:-}
      # Optional - Ports
      - HTTP_PORT=${HTTP_PORT:-80}
      - HTTPS_PORT=${HTTPS_PORT:-443}
      - DNS_PORT=${DNS_PORT:-53}
      - SMTP_PORT=${SMTP_PORT:-25}
      # Optional - TLS/ACME
      - TLS_ENABLED=${TLS_ENABLED:-false}
      - ACME_EMAIL=${ACME_EMAIL:-}
      - ACME_DIRECTORY=${ACME_DIRECTORY:-https://acme-v02.api.letsencrypt.org/directory}
      - CERT_RENEWAL_DAYS=${CERT_RENEWAL_DAYS:-7}
      - CERT_CHECK_HOURS=${CERT_CHECK_HOURS:-12}
      # Optional - Memory management
      - CACHE_MAX_MEMORY_PCT=${CACHE_MAX_MEMORY_PCT:-0.7}
      - MAX_SUBDOMAIN_SIZE_MB=${MAX_SUBDOMAIN_SIZE_MB:-10}
      # Logging
      - RUST_LOG=${RUST_LOG:-info}
    volumes:
      - certs:/app/certs
    # Memory limits - adjust based on your needs
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 256M
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://127.0.0.1:80/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    # Security options
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE  # Required for binding to ports < 1024
    tmpfs:
      - /tmp

# Named volumes for persistent data
volumes:
  certs:
    driver: local
